---
title: JAVA BIO 与 NIO 简介
categories:
- JAVA
tags:
- IO
---
# 概述
I/O操作是系统中十分基础且重要的操作，同样也很容易产生性能瓶颈。本文以网络IO为使用场景，首先介绍BIO模式并点出其局限性。然后再介绍NIO是如何改善上述问题的。最后总结BIO和NIO的区别。

<!-- more -->

# BIO
目前网络模型一般是客户端或服务端通过网络向对方发送或接收对方的消息。这种通过网络输入\输出信息的操作就是网络IO操作。网络IO的本质是socket流的写入\读取。  
进一步来讲就是，服务端在启动时监听系统中的某个端口，客户端根据服务端IP以及端口向服务端发起连接请求，通过三次握手建立连接，然后就可以通过socket流进行通信。  
在传统的同步阻塞（blocking IO）模型开发(JAVA)中整个流程表现为服务端创建ServerSocket对象绑定IP，启动监听端口，等待客户端连接。客户端构建Socket对象发起连接请求。服务端在接收到连接后同样回得到一个socket对象。然后双方就可以从socket中获取inputStream或outputStream从而进行信息交互。需要特别注意的是服务端在等待连接接入时会阻塞线程，C/S（客户端和服务端）在等待接收数据时也会阻塞进程。如果一方不断将数据写入socket流中而另一端没有接收的话，那么数据首先会堆积在对方协议栈的接收缓冲区里，如果堆满会导致写操作被阻塞。（另，注意区分传输层TCP的ack和应用层的recv）  
在这种情况下通常使用的模型是：在采用BIO通信模型的服务端，一般使用一个独立的Acceptor线程负责监听客户端的连接，它接收到客户端连接请求后为每个客户端创建一个新的线程进行链路处理，处理主要包括接收信息，处理业务逻辑以及回写信息，处理完成后销毁线程。如下图所示：
![bio mode](https://rfc2616.oss-cn-beijing.aliyuncs.com/blog/BIO-mode.png)  
在这个模型中，我们为每个连接创建了线程，并且有个专门的线程负责接收连接。这样做的主要原因是socket.accept(),socket.write()，三个主要函数是同步阻塞的，如果是单线程的话同一时间只能做这3件事中的一件，即写数据时不能再接收新的连接。开启多线程，就可以让CPU去处理更多的事情。其实这也是所有使用多线程的本质： 1. 利用多核。 2. 当I/O阻塞系统，但CPU空闲的时候，可以利用多线程使用CPU资源。   
![bio pool](https://rfc2616.oss-cn-beijing.aliyuncs.com/blog/BIO-POOL.png)
现在的多线程一般都使用线程池，可以让线程的创建和回收成本相对较低(如上图伪异步IO模型图)。在活动连接数不是特别高（小于单机1000）的情况下，这种模型是比较不错的，可以让每一个连接专注于自己的I/O并且编程模型简单，也不用过多考虑系统的过载、限流等问题。线程池本身就是一个天然的漏斗，可以缓冲一些系统处理不了的连接或请求。  
不过，这个模型最本质的问题在于，严重依赖于线程。但线程是很”贵”的资源，主要表现在：
 1. 线程的创建和销毁成本很高，在Linux这样的操作系统中，线程本质上就是一个进程。创建和销毁都是重量级的系统函数。 
 2. 线程本身占用较大内存，像Java的线程栈，一般至少分配512K～1M的空间，如果系统中的线程数过千，恐怕整个JVM的内存都会被吃掉一半。 
 3. 线程的切换成本是很高的。操作系统发生线程切换的时候，需要保留线程的上下文，然后执行系统调用。如果线程数过高，可能执行线程切换的时间甚至会大于线程执行的时间，这时候带来的表现往往是系统load偏高、CPU sy使用率特别高（超过20%以上)，导致系统几乎陷入不可用的状态。 
 4. 容易造成锯齿状的系统负载。因为系统负载是用活动线程数或CPU核心数，一旦线程数量高但外部网络环境不是很稳定，就很容易造成大量请求的结果同时返回，激活大量阻塞线程从而使系统负载压力过大。
 
# 


同步和异步的概念描述的是用户线程与内核的交互方式：同步是指用户线程发起IO请求后需要等待或者轮询内核IO操作完成后才能继续执行；而异步是指用户线程发起IO请求后仍继续执行，当内核IO操作完成后会通知用户线程，或者调用用户线程注册的回调函数。

阻塞和非阻塞的概念描述的是用户线程调用内核IO操作的方式：阻塞是指IO操作需要彻底完成后才返回到用户空间；而非阻塞是指IO操作被调用后立即返回给用户一个状态值，无需等到IO操作彻底完成。
 


# 参考
https://blog.csdn.net/anxpp/article/details/51512200  
https://tech.meituan.com/2016/11/04/nio.html